{% load i18n static has_group crispy_forms_tags   %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script> -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
    
    
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    
    
    
    <!-- <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script> -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>
    <link href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css" rel="stylesheet" type="text/css" />


    <link rel="stylesheet" href="{% static 'css/judgment-reset.css' %}" />
    <link rel="stylesheet" href="{% static 'css/judgment-main.css' %}" />
<!-- 
    <link rel="stylesheet" href="{% static 'css/judgment-main.css' %}" /> -->

    <script src="{% static 'js/jquery.minimap.min.js' %}"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">

    <link rel="icon" href="{% static 'images/favicon.png' %}" type="image/x-icon">
    <title>Document</title>
</head>
<body>
    
    
    <div class="main">
        <div class="header">
            <div class="header-btn-container">
                <form method='post' action="{% url 'judgment:judgment'%}">
                    {% csrf_token %}            
                    <button class="button prev-document" type="submit" value="prev" name="prev">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"><path d="M16.67 0l2.83 2.829-9.339 9.175 9.339 9.167-2.83 2.829-12.17-11.996z"/>
                        </svg>
                        Undo
                    </button>
                </form> 
                
                <button class="button topic-info-button" id="topic_info_li">
                    <h3>Topic Information</h3>
                </button>
            </div>

            <div class="question">
                <p>I prefer</p>
                    <div class="answer-box">
                        <form method='post'>
                            {% csrf_token %}
                            <button class="button" type="submit" value="left" name="left">Left</button>
                            <button class="button" type="submit" value="equal" name="equal">Equal</button>
                            <button class="button" type="submit" value="right" name="right">Right</button>
                        </form>  
                    </div>
            </div>  
            
            <div class="progress-txt">
                <h3><strong>Progress: {{ progress_bar_width }}% </strong></h3>
            </div>
             
            <div>
              <div class="btn-group">
                <button type="button" class="btn dropdown-toggle "  data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                    <svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 24 24" width="30px" height="30px"><path d="M2 11H22V13H2zM2 5H22V7H2zM2 17H22V19H2z"/></svg>
                </button>

                <ul class="dropdown-menu dropdown-menu-right">
                    <li class="dropdown-item"><a href="{% url 'core:home' %}">Home</a></li>
                    <li class="divider"></li>
                    <li class="dropdown-item"><a href="{% url 'account_logout' %}">Log out</a></li>
                  </ul>
              </div>
            </div>
        </div>

        <div class="tag-container">
            <input name='tags_words' value="{{ highlights }}">
        </div>


        <div id="debug-div"class="tree-container">
            <div class="previous-action">
            <b>Previous action</b>: {{previous_action}}
            </div>
            <div class="tree-content">
                {{ tree_content}}
            </div>
        </div>

            
        <div class="documents" id="wrapper">
            <div class="document-left" id="drag-left">
                <div> 
                    <h2 class="document-url">
                        <a href="{{doc_left.url}}" target=”_blank” rel="noopener noreferrer">
                            {{doc_left.url}}
                        </a>
                    </h2>
                    <div class="font-size-div">
                        <button id="left-decrase-btn" class="btn btn-primary btn-circle">-</button>
                        <button id="left-increase-btn" class="btn btn-primary btn-circle">+</button>
                    </div>
                </div>
                <div class="document-content" >
                    <p id="left-doc" class="editable-doc" >
                        {% autoescape off %}
                            {{ left_txt }}
Title: {{doc_left.title}}

Document ID : {{doc_left.uuid}}
                        {% endautoescape %} 
                    </p>
                </div>
            </div>

            <div class="dragbar" id="dragbar">
                <span class="dragbar-dot"></span>
                <span class="dragbar-dot"></span>
                <span class="dragbar-dot"></span>
            </div>

            <div class="document-right" id="drag-right">
                <div>
                    <h2 class="document-url">
                        <a href="{{doc_right.url}}" target=”_blank” rel="noopener noreferrer">{{doc_right.url}}</a>
                    </h2>
                    <div class="font-size-div">
                        <button id="right-decrase-btn" class="btn btn-primary btn-circle">-</button>
                        <button id="right-increase-btn" class="btn btn-primary btn-circle">+</button>
                    </div>
                </div>
                
                <div class="document-content">
                    <p id="right-doc" class="editable-doc">
                        
                        {% autoescape off %}
                            {{ right_txt }}
                            
Title: {{doc_right.title}}

Document ID : {{doc_right.uuid}}
                        {% endautoescape %} 
                    </p>
                    
                </div>
            </div>
        </div>
    </div>
    

    <!-- COMPLETE TASK MODAL -->
    <div class="modal fade" id="ccomplete-modal" role="dialog">
        <div class="modal-dialog">
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header" style="padding:35px 50px;">
                    <h3>This task is DONE!</h3>
                </div>
                <div class="modal-body" style="padding:40px 50px;">
                    <form method='post'>
                        {% csrf_token %}
                        <button type="submit" class="btn btn-success btn-block" name="back_home">
                                Home
                        </button>
                    </form>
                    </div>
                </div>
        </div>
    </div>
    
    <!-- TOPIC INFO MODAL -->
    <div class="modal fade" id="topic-info-modal" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="padding:35px 50px;">
                    <div class="question-header">
                        {{ topic.title }}
                    </div>
                    <div class="question-description">
                        {{ topic.description }}
                    </div>
                    
                </div>
                <div class="modal-body" style="padding:40px 50px;">
                        <button type="submit" class="btn btn-success btn-block" data-dismiss="modal">OK</button>
                    </div>
                </div>
        </div>
    </div>

    <!-- JavaScript Block -->
    <script>

        $(function (){

            $('.nav').hide(); 

            $('.menu-btn').click(function (){ 
                $('.nav').toggle(300);
            });

            $('.sub-menu').hide(); 

            $('.nav li.expand').click(function(){ 
                $('.sub-menu').toggle(300);
            });

        });

      function disableBack() { window.history.forward(); }
        setTimeout("disableBack()", 0);
        window.onunload = function () { null };

        history.pushState(null, null, location.href);
        window.onpopstate = function () { history.go(1); };

        
      function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== "") {
                        const cookies = document.cookie.split(";");
                        for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + "=")) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
            return cookieValue;
        }

        mouseXPosition = 0;

        $(document).ready(function () {
            
            const debug = "{{debug}}"
            if(debug=="true"){
                $("#debug-div").show();
            }

            const task_status = "{{task_status}}"
            if(task_status=="complete"){
                $("#ccomplete-modal").modal({backdrop: 'static', keyboard: false});
            }


            $('#topic_info_li').on('click', function() {
                $('#topic-info-modal').modal();
            });
        });
        

        $("button").click( function(e3){
            var right_doc_highlights = "";
            var left_doc_highlights = "";

            $('.highlighter').each(function(e4){
                if ($(this).parent().attr("id")=='left-doc'){
                    left_doc_highlights +=  $(this).html() + "|||"
                    
                }else{
                    right_doc_highlights +=  $(this).html() + "|||";
                }
            });
            
            var data = {"highlight": left_doc_highlights}
            $.ajax
            ({ 
                url: "/../../add_highlight/" + getCookie("left_doc_id") + "/" ,
                data: JSON.stringify(data),
                method: 'PUT',

                credentials: "same-origin",
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                    "X-CSRFToken": getCookie("csrftoken"),
                },
                success: function(result)
                {
                    console.log(result)
                },
                error: (error) => {
                    console.log(error)
                },
            });
            var data = {"highlight": right_doc_highlights}

            $.ajax
            ({ 
                url: "/../../add_highlight/" + getCookie("right_doc_id") + "/" ,
                data: JSON.stringify(data),
                method: 'PUT',

                credentials: "same-origin",
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                    "X-CSRFToken": getCookie("csrftoken"),
                },
                success: function(result){
                    console.log(result)
                },
                error: (error) => {
                    console.log(error)
                },
            });
        })

        function highlight_tags(search_area, tag){
            
            if (tag.length <2) return
            
            // in the case there is more than one word in tag
            tags = tag.split("|")
            tag = tags[0]
            color = tags[1]

            splited = tag.split(" ")
            if (splited.length > 1){
                temp = ""
                for (let i = 0; i < splited.length; i++) { 
                   if(i ==splited.length || i ==0){
                    temp += splited[i]
                   }else{
                    temp += "[^a-zA-Z\d]" + splited[i]
                   }
                }
                tag = temp
            }

            
            var textarea = $(search_area);    
            var query = new RegExp("("+tag+")", "gim"); 
            
            const markTag = "<mark style='background: "+ color +"!important'>"
            newtext= textarea.html().replace(query, markTag+"$1</mark>");    
            textarea.html(newtext);
        }

        
        function dehighlight_tags(search_area, tag, second){


            tags = tag.split("|")
            tag = tags[0]
            color = tags[1]
           
            
            var textarea = $(search_area);    
            var enew = ''; 

            // in the case there is more than one word in tag
            splited = tag.split(" ")
            if (splited.length > 1){
                temp = ""
                for (let i = 0; i < splited.length; i++) { 
                   if(i ==splited.length || i ==0){
                    temp += splited[i]
                   }else{
                    temp += "[^a-zA-Z\d]" + splited[i]
                   }
                }
                tag = temp
            }

            var tagColorDic = localStorage['colorDic']
            var colorList = localStorage['colorList']
            var isConstColor = false;
            
            tagColorDic = JSON.parse(tagColorDic);
            colorList = JSON.parse(colorList);

            color = tagColorDic[tag.toLowerCase()]
            if (color == null){
                // After 20 tags we use a constant color
                color = "#fa9fb5";
                isConstColor = true;
            }
            if (second == true && !isConstColor){

                colorList.push(color)
                delete tagColorDic[tag.toLowerCase()]

                localStorage['colorList'] = JSON.stringify(colorList);
                localStorage['colorDic'] = JSON.stringify(tagColorDic);

            }
        
            const markTag = "<mark style=\"background: " +color.replace("(", "\\(").replace(")", "\\)") +"!important\">"    
            var query = new RegExp("("+markTag+tag+")", "gim");   
            cases = textarea.html().match(query)
            if (cases !=null){
                for (let i = 0; i < cases.length; i++) { 
                    t = cases[i].replace(markTag.replace("\\(", "(").replace("\\)",")"),"");
                    t = t.replace("</mark>","");
                    newtext= textarea.html().replace(cases[i], t);    
                    textarea.html(newtext); 
                }
            }
        }

        // TAGIFY
        var input = document.querySelector('input[name=tags_words]'),
        tagify = new Tagify(input, {
            transformTag        : transformTag,
            placeholder         : "Search keywords",
            
            
        })
        
        const colorGlobalList = [
            "#d53e4f", "#f46d43", "#fdae61", "#fee08b",
            "#e6f598", "#abdda4", "#66c2a5", "#3288bd",
            "#5e4fa2", "#8073ac", "#b2abd2", "#d8daeb", 
            "#fee0b6", "#fdb863", "#e08214", "#dfc27d",
            "#f6e8c3", "#c7eae5", "#80cdc1", "#35978f",
        ]

        // generate a random color (in HSL format, which I like to use)
        function getTagColor(tag){

            var randomColor
            var tagColorDic = localStorage['colorDic']
            var colorList = localStorage['colorList']
            tagLower = tag.toLowerCase()

            
            if (tagColorDic==null){
                tagColorDic = {}
            }else{
                tagColorDic = JSON.parse(tagColorDic);
            }
            if(colorList==null){
                colorList = colorGlobalList
            }else{
                colorList = JSON.parse(colorList);
            }

            if (tagLower in tagColorDic){
                randomColor = tagColorDic[tagLower]
            }else{
                randomColor = colorList.shift()
                tagColorDic[tagLower] = randomColor

                localStorage['colorList'] = JSON.stringify(colorList);
                localStorage['colorDic'] = JSON.stringify(tagColorDic);
            }
            if (randomColor == null){
                // After 20 tags we use a constant color
                randomColor = "#fa9fb5";
            }
            return randomColor
            
        }

        function transformTag( tagData ){
            var tags = tagData["value"].split("|")

            if (tags.length > 1) {
                tagData.color = tags[1].replaceAll(".",",");
                tagData.value = tags[0];
                const value = tagData.value +"|"+tagData.color
                highlight_tags("#left-doc", value)
                highlight_tags("#right-doc", value)
            } else{
                tagData.color = getTagColor(tags[0]);
            }
            
            tagData.style = "--tag-bg:" + tagData.color;

        }

        tagify.on('add', function(e, tagData){

            const value = e.detail["data"]["value"] + "|" + e.detail["data"]["color"]

            const data ={
                tags:value
            } 
            var put_url = "/../../add_tag/" + getCookie("task_id") + "/" 
            fetch(put_url, {
                method: "PUT",
                credentials: "same-origin",
                headers: {
                "X-Requested-With": "XMLHttpRequest",
                "X-CSRFToken": getCookie("csrftoken"),
                },
                body: JSON.stringify({payload: data})
            })
            .then(response => 
                response.json()
            )
            .then(data => {
                highlight_tags("#left-doc", value)
                highlight_tags("#right-doc", value)

            });
        })


        tagify.on('remove', function(e){            
            const value = e.detail["data"]["value"] + "|" + e.detail["data"]["color"]
            
            const data ={
                tags:value
            }

            var put_url = "/../../remove_tag/" + getCookie("task_id") + "/" 
            fetch(put_url, {
                method: "PUT",
                credentials: "same-origin",
                headers: {
                "X-Requested-With": "XMLHttpRequest",
                "X-CSRFToken": getCookie("csrftoken"),
                },
                body: JSON.stringify({payload: data})
            })
            .then(response => response.json())
            .then(data => {
                dehighlight_tags("#left-doc", value, false)
                dehighlight_tags("#right-doc", value, true)
            });
        })

        
        // New Highlighting Method!
        var flag = 0;
        var target;
        $(".editable-doc").mousedown(function (e1) {
            flag = 0;
            target = e1.target;

        });

        $(".editable-doc").mousemove(function (e1) {
            flag = 1;
        });

        $(".editable-doc").mouseup(function (e1) {
            if (e1.target != target){
                return;
            }
            if (flag === 1) {
                getSelText();
            }
        });

        function getSelText() {
            var sel = window.getSelection ? window.getSelection() : document.selection.createRange(); // FF : IE
            if (sel.getRangeAt) { 
                var range = sel.getRangeAt(0);
                
                var newNode = document.createElement("span");
                newNode.setAttribute('class', 'highlighter');
                newNode.textContent = sel.toString();

                sel.deleteFromDocument();
                range.insertNode(newNode);
            } else { 
                sel.pasteHTML('<span class="highlighter">' + sel.htmlText + '</span>');

            }
        }



    // // DragBar
        var left = document.getElementById('drag-left');
        var bar = document.getElementById('dragbar');
        var isHandlerDragging = false;

        var handler = document.querySelector('.dragbar');

       
        document.addEventListener('mousedown', function(e) {
            if (e.target === handler) {
                isHandlerDragging = true;
                return;
            }
        });

        document.addEventListener('mousemove', function(e) {
            if (!isHandlerDragging) {
                return false;
            }
            document.selection ? document.selection.empty() : window.getSelection().removeAllRanges();
            left.style.width = (e.pageX - bar.offsetWidth / 2)+ 'px';

        });

        document.addEventListener('mouseup', function(e) {
            isHandlerDragging = false;
        });



        // FONT CHANGE

        $("#left-increase-btn").click(function(){
            changeFontSize(1, "left-doc");
        })

        $("#left-decrase-btn").click(function(){
            changeFontSize(-1, "left-doc");
        })
        $("#right-increase-btn").click(function(){
            changeFontSize(1, "right-doc");
        })

        $("#right-decrase-btn").click(function(){
            changeFontSize(-1, "right-doc");
        })

        function changeFontSize(direction, element){
            var element = document.getElementById(element);
            style = window.getComputedStyle(element, null).getPropertyValue('font-size');
            currentSize = parseFloat(style);
            element.style.fontSize = (currentSize + direction) + 'px';
        }

    // Minimpa :))))))))))))))))))))
        
    </script>
</body>
</html>